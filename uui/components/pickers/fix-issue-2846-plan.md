# План исправления Issue #2846: [Picker Input] некорректный цвет иконки

## 1. Анализ проблемы

Проблема заключается в том, что компонент `PickerInput` с `selectionMode="single"`, `editMode="modal"` и ленивой загрузкой данных некорректно отображает состояние выбора при смене выбора с дочернего элемента на родительский. Иконка выбранного родителя остается темной вместо ожидаемой синей. Это указывает на проблему в обновлении состояния или стилей элемента.

## 2. Локализация кода

Для исправления необходимо исследовать следующие части кодовой базы:

1.  **`PickerInput`**: Основной компонент, с которого начинается взаимодействие.
2.  **`PickerModal`**: Компонент, отвечающий за отображение в модальном окне (`editMode="modal"`).
3.  **`DataPickerBody`**: Тело пикера, где отображаются строки данных.
4.  **`PickerItem` / `DataPickerRow`**: Компоненты, отвечающие за рендеринг отдельной строки. Именно здесь, скорее всего, определяется цвет иконки.
5.  **`usePicker` / `usePickerList`**: Хуки, управляющие состоянием и логикой пикера.
6.  **`LazyDataSource` / `AsyncDataSource`**: Логика работы с данными, особенно методы, связанные с выбором (`select`, `getById`).

## 3. План исправления

### Шаг 1: Воспроизведение проблемы локально

- Создать тестовую страницу или песочницу в `app/src/sandbox/`, которая использует `PickerInput` с `LazyDataSource` (например, `lazyLocationsDS`) в режиме модального окна.
- Следовать шагам из issue для воспроизведения бага: выбрать дочерний элемент, закрыть модальное окно, открыть снова и выбрать родительский элемент.
- Убедиться, что проблема стабильно воспроизводится.

### Шаг 2: Отладка и поиск корневой причины

- **Проверить состояние**: Используя React DevTools, изучить пропсы и состояние компонентов `DataPickerRow` и `PickerItem` в момент проявления бага. Обратить внимание на пропсы `isSelected`, `isChildrenSelected`.
- **Проанализировать `DataPickerRow`**:
    - Изучить файл `uui/components/pickers/DataPickerRow.tsx`.
    - Найти код, который отвечает за рендеринг иконки выбора. Вероятно, это `renderCheckbox` или похожая функция.
    - Проверить, какие CSS-классы и стили применяются к иконке в зависимости от состояния `isSelected`.
- **Проанализировать логику выбора**:
    - Изучить хук `usePickerList` (`uui/components/pickers/hooks/usePickerList.ts`), который, скорее всего, управляет `checked` и `selected` состояниями.
    - Обратить внимание, как обрабатывается выбор родительского элемента, когда дочерний уже выбран. Возможно, `single` режим неверно отменяет предыдущий выбор.
    - Изучить, как `view.getSelectedRows()` обновляется.

### Шаг 3: Внесение исправлений

- **Корректировка логики**:
    - Скорее всего, потребуется изменить логику в `usePickerList.ts` или в самом `DataPickerRow.tsx`.
    - При `selectionMode="single"`, при любом новом выборе нужно убедиться, что предыдущий выбор (будь то родитель или дочерний элемент) полностью сбрасывается.
    - Возможно, потребуется явно передавать обновленное состояние выбора в `DataPickerRow` или пересчитывать его внутри.
- **Корректировка стилей/классов**:
    - Если логика верна, но иконка не обновляется, проверить, что `cx` (classnames) правильно применяет классы, отвечающие за "выбранное" состояние.

### Шаг 4: Тестирование

- После внесения исправлений повторить шаги для воспроизведения и убедиться, что баг исправлен.
- Проверить смежные сценарии:
    - `selectionMode="multi"`.
    - Разные типы `dataSource` (`ArrayDataSource`, `AsyncDataSource`).
    - Разные `editMode` (`dropdown`).
    - Вложенность разного уровня.
- Убедиться, что исправление не сломало другие части функциональности `PickerInput`.

### Шаг 5: Создание Pull Request

- Подготовить коммит с осмысленным сообщением.
- Создать Pull Request, связав его с issue #2846.
- Добавить описание проделанной работы и шаги для проверки.